# Cursor架构图文本描述

## 整体架构层次
```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                 │
├─────────────────────────────────────────────────────────────┤
│                       客户端层                                │
├─────────────────────────────────────────────────────────────┤
│                       网络层                                  │
├─────────────────────────────────────────────────────────────┤
│                      后端服务层                               │
├─────────────────────────────────────────────────────────────┤
│                     数据存储层                                │
├─────────────────────────────────────────────────────────────┤
│                    计算资源层                                 │
└─────────────────────────────────────────────────────────────┘
```

## 详细组件布局

### 1. 客户端层 (IDE)
**主要组件：**
- Cursor IDE 编辑器界面
- 本地文件管理器
- 代码编辑器
- Tab自动补全界面
- 聊天界面
- 本地Merkle树生成器
- 加密引擎

### 2. 网络通信层
**数据流类型：**
- 加密代码上下文传输 (自动补全)
- 加密代码块传输 (索引)
- 聊天查询请求
- Merkle树同步
- 搜索请求/响应

### 3. 后端服务层 (单体架构)
**核心服务组件：**
- **Orchestrator (Rust)** - 性能关键组件
- **业务逻辑服务 (TypeScript/Node.js)**
- **代码解密服务**
- **LLM推理服务**
- **索引管理服务**
- **搜索引擎**
- **Merkle树比较服务**

**支持服务：**
- 身份验证服务 (WorkOS集成)
- 计费服务 (Stripe集成)
- 监控服务 (Datadog集成)

### 4. 数据存储层
**数据库集群：**
- **Turbopuffer** (多租户数据库)
  - 存储加密文件
  - 存储Merkle树
- **Pinecone** (向量数据库)
  - 存储文档embeddings
  - 支持向量搜索

**流数据：**
- **Warpstream** (Kafka兼容)

### 5. 计算资源层
**GPU集群：**
- AWS CPU基础设施
- Azure GPU集群 (数万块NVIDIA H100)
  - 专用于LLM推理
  - Tab补全模型
  - 聊天模型
  - Embedding生成

**基础设施管理：**
- Terraform管理

## 关键数据流路径

### A. 自动补全流程 (低延迟同步引擎)
```
用户输入 → 本地上下文收集 → 加密 → 后端解密 → LLM推理 → 补全建议 → 客户端显示
```

### B. 聊天搜索流程
```
用户提问 → 服务器解析 → 向量搜索(Pinecone) → 请求相关源码 → LLM分析 → 生成回答
```

### C. 代码索引流程  
```
本地代码 → 分块 → 加密 → 后端解密 → Embedding生成 → 存储到Turbopuffer
```

### D. 增量同步流程 (高延迟同步引擎)
```
本地Merkle树 ↔ 服务器Merkle树比较 → 识别差异 → 增量重新索引
```

## 关键连接关系

1. **IDE ↔ 后端服务**：双向加密通信
2. **后端服务 ↔ GPU集群**：推理请求
3. **后端服务 ↔ Turbopuffer**：Merkle树存储
4. **后端服务 ↔ Pinecone**：向量搜索
5. **Orchestrator ↔ 各服务**：性能优化调度
6. **监控系统 → 所有组件**：日志和性能监控

## 技术栈详情

### 后端技术栈
- **TypeScript**: 大多数业务逻辑
- **Rust**: 性能关键组件 (Orchestrator等)
- **Node.js**: TypeScript运行环境
- **单体架构**: 便于快速迭代开发

### 数据库技术栈
- **Turbopuffer**: 多租户数据库，存储加密文件和Merkle树
- **Pinecone**: 向量数据库，存储文档embeddings
- **Warpstream**: Kafka兼容的流数据服务

### 监控和工具栈
- **Datadog**: 日志记录和监控
- **PagerDuty**: 值班管理
- **Sentry**: 错误监控
- **Amplitude**: 分析
- **Stripe**: 计费和付款
- **WorkOS**: 身份验证
- **Vercel**: 网站托管

### 基础设施
- **AWS**: CPU基础设施
- **Azure**: GPU集群 (NVIDIA H100)
- **Terraform**: 基础设施管理

## 安全特性

### 数据保护
- **端到端加密**: 所有代码传输都加密
- **服务器不存储源码**: 后端仅处理不存储
- **敏感数据检测**: 上传前扫描并过滤机密信息
- **文件名混淆**: 连文件名都不明文存储

### 隐私保护
- **尊重.gitignore**: 不索引被忽略的文件
- **.cursorignore**: 额外的忽略文件支持
- **本地处理**: 敏感操作尽量在本地完成
